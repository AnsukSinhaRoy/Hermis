#!/usr/bin/env python3
from __future__ import annotations

import sys
import subprocess
from pathlib import Path

HELP = (
    "levitate - Hermis experiment launcher\n"
    "\n"
    "Default is DETACHED (terminal becomes free).\n"
    "\n"
    "Examples:\n"
    "  levitate --newconfig.yaml\n"
    "  levitate configs/newconfig.yaml\n"
    "  levitate --newconfig.yaml --tag trial1\n"
    "  levitate --newconfig.yaml --fg\n"
    "\n"
    "Shorthand:\n"
    "  --NAME.yaml expands to configs/NAME.yaml (relative to repo)\n"
    "\n"
    "Options:\n"
    "  --fg, --foreground  Run in foreground (not detached)\n"
    "  --no-detach         Same as --fg\n"
    "  --detach            Force detached mode\n"
    "\n"
    "All other args are forwarded to run_experiment.py.\n"
)


def _strip_flag(argv: list[str], *flags: str) -> bool:
    found = False
    for f in flags:
        while f in argv:
            argv.remove(f)
            found = True
    return found


def _expand_shorthand_config(argv: list[str], repo_root: Path) -> list[str]:
    """If argv contains `--NAME.yaml` (not --config/--configs), expand to --config configs/NAME.yaml."""
    if "--config" in argv or "--configs" in argv:
        return argv

    # Pattern: something that looks like --<something>.yaml
    for a in list(argv):
        if not (a.startswith("--") and a.lower().endswith(".yaml")):
            continue
        if a in ("--fg", "--foreground", "--no-detach", "--detach", "--help", "-h"):
            continue

        name = a[2:]
        argv.remove(a)

        # If user wrote a path after the --, keep that path.
        # Otherwise assume it's under configs/.
        if "/" in name or "\\" in name:
            config_path = name
        else:
            config_path = str(repo_root / "configs" / name)

        return ["--config", config_path] + argv

    # Alternative: first positional argument is a yaml
    if argv and argv[0].lower().endswith(".yaml"):
        first = argv.pop(0)
        if "/" in first or "\\" in first:
            config_path = first
        else:
            # prefer a literal file in cwd, else repo configs/
            if Path(first).exists():
                config_path = first
            else:
                config_path = str(repo_root / "configs" / first)
        return ["--config", config_path] + argv

    return argv


def main(argv: list[str] | None = None) -> int:
    argv = list(sys.argv[1:] if argv is None else argv)

    if not argv or "--help" in argv or "-h" in argv:
        print(HELP)
        return 0

    # Default: detached (since you want to replace the old --detach command)
    detach = True

    # Foreground overrides
    if _strip_flag(argv, "--fg", "--foreground", "--no-detach"):
        detach = False

    # Explicit detach overrides back
    if _strip_flag(argv, "--detach"):
        detach = True

    repo_root = Path(__file__).resolve().parent
    runner = repo_root / "run_experiment.py"
    if not runner.exists():
        print("ERROR: could not find run_experiment.py next to levitate")
        print(f"  looked for: {runner}")
        return 2

    argv = _expand_shorthand_config(argv, repo_root)

    # If still no config, show help
    if "--config" not in argv and "--configs" not in argv:
        print("ERROR: no config provided.")
        print()
        print(HELP)
        return 2

    # Ensure detach flag consistent with desired mode
    if detach:
        if "--detach" not in argv:
            argv.append("--detach")
    else:
        while "--detach" in argv:
            argv.remove("--detach")

    cmd = [sys.executable, str(runner)] + argv
    return subprocess.call(cmd)


if __name__ == "__main__":
    raise SystemExit(main())
